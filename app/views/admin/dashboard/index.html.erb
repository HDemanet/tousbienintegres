<!-- app/views/admin/dashboard/index.html.erb -->
<% set_meta_tags title: 'Dashboard Admin' %>

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3">
        <i class="fas fa-tachometer-alt me-2" aria-hidden="true"></i>
        Tableau de bord
      </h1>
      <p class="text-muted">Bienvenue <%= current_user.first_name %></p>
    </div>
    <div class="col-auto">
      <%= link_to rails_admin_path, class: 'btn btn-primary' do %>
        <i class="fas fa-cog me-2" aria-hidden="true"></i>
        Rails Admin
      <% end %>
    </div>
  </div>

  <!-- Statistiques principales -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <i class="fas fa-clipboard-list fa-3x mb-3" style="color: #EF5327;" aria-hidden="true"></i>
          <h2 class="h2 mb-0"><%= @total_responses %></h2>
          <p class="text-muted mb-0">Réponses totales</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <i class="fas fa-user-check fa-3x mb-3" style="color: #018837;" aria-hidden="true"></i>
          <h2 class="h2 mb-0"><%= @electoral_registered %></h2>
          <p class="text-muted mb-0">Inscrits liste électorale</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <i class="fas fa-hands-helping fa-3x mb-3" style="color: #5F8CC7;" aria-hidden="true"></i>
          <h2 class="h2 mb-0"><%= @volunteers_count %></h2>
          <p class="text-muted mb-0">Intéressés newsletter</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <i class="fas fa-newspaper fa-3x mb-3" style="color: #292929;" aria-hidden="true"></i>
          <h2 class="h2 mb-0"><%= @published_articles.count %></h2>
          <p class="text-muted mb-0">Articles publiés</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Réponses récentes -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">
            <i class="fas fa-clock me-2" aria-hidden="true"></i>
            Réponses récentes
          </h2>
          <%= link_to "Voir toutes", rails_admin.index_path(model_name: 'survey_response'), class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Ville</th>
                  <th>Âge</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% @recent_responses.each do |response| %>
                  <tr>
                    <td><%= l(response.created_at, format: :short) %></td>
                    <td><%= response.first_name %> <%= response.last_name %></td>
                    <td><%= response.email %></td>
                    <td><%= response.city %></td>
                    <td><span class="badge bg-secondary"><%= response.age_range %></span></td>
                    <td>
                      <%= link_to rails_admin.show_path(model_name: 'survey_response', id: response.id), class: "btn btn-sm btn-outline-primary" do %>
                        <i class="fas fa-eye" aria-hidden="true"></i>
                        Voir
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphiques statistiques -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">
            <i class="fas fa-map-marker-alt me-2" aria-hidden="true"></i>
            Répartition par ville (Top 10)
          </h2>
        </div>
        <div class="card-body">
          <canvas id="cityChart" aria-label="Graphique de répartition par ville" role="img"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">
            <i class="fas fa-birthday-cake me-2" aria-hidden="true"></i>
            Répartition par âge
          </h2>
        </div>
        <div class="card-body">
          <canvas id="ageChart" aria-label="Graphique de répartition par tranche d'âge" role="img"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">
            <i class="fas fa-calendar-alt me-2" aria-hidden="true"></i>
            Années de résidence en Belgique
          </h2>
        </div>
        <div class="card-body">
          <canvas id="yearsChart" aria-label="Graphique des années de résidence" role="img"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">
            <i class="fas fa-file-alt me-2" aria-hidden="true"></i>
            Articles récents
          </h2>
        </div>
        <div class="card-body">
          <% if @published_articles.any? %>
            <ul class="list-unstyled mb-0">
              <% @published_articles.each do |article| %>
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
                  <%= link_to article.title, rails_admin.show_path(model_name: 'article', id: article.id) %>
                  <small class="text-muted d-block ms-4">
                    <%= l(article.published_at, format: :short) %>
                  </small>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-muted mb-0">Aucun article publié</p>
          <% end %>

          <% if @draft_articles.any? %>
            <hr>
            <p class="text-muted small mb-2">Brouillons :</p>
            <ul class="list-unstyled mb-0">
              <% @draft_articles.each do |article| %>
                <li class="mb-2">
                  <i class="fas fa-edit text-warning me-2" aria-hidden="true"></i>
                  <%= link_to article.title, rails_admin.edit_path(model_name: 'article', id: article.id) %>
                </li>
              <% end %>
            </ul>
          <% end %>

          <div class="mt-3">
            <%= link_to rails_admin.new_path(model_name: 'article'), class: "btn btn-sm btn-primary w-100" do %>
              <i class="fas fa-plus me-2" aria-hidden="true"></i>
              Nouvel article
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Couleurs de la charte MoDem
  const modemColors = {
    orange: '#EF5327',
    blue: '#5F8CC7',
    green: '#018837',
    black: '#292929',
    gray: '#6C757D'
  };

  // Graphique villes
  const cityData = <%= raw @stats_by_city.to_json %>;
  new Chart(document.getElementById('cityChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(cityData),
      datasets: [{
        label: 'Réponses',
        data: Object.values(cityData),
        backgroundColor: modemColors.orange,
        borderColor: modemColors.orange,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Graphique âge
  const ageData = <%= raw @stats_by_age.to_json %>;
  new Chart(document.getElementById('ageChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(ageData),
      datasets: [{
        data: Object.values(ageData),
        backgroundColor: [
          modemColors.orange,
          modemColors.blue,
          modemColors.green,
          modemColors.black,
          modemColors.gray,
          '#FFA500'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true
    }
  });

  // Graphique années
  const yearsData = <%= raw @stats_by_years.to_json %>;
  new Chart(document.getElementById('yearsChart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(yearsData),
      datasets: [{
        data: Object.values(yearsData),
        backgroundColor: [
          modemColors.orange,
          modemColors.blue,
          modemColors.green,
          modemColors.black,
          modemColors.gray
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true
    }
  });
</script>
