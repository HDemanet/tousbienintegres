<!-- app/views/admin/dashboard/index.html.erb -->
<% set_meta_tags title: 'Administration' %>

<div class="admin-simple">
  <div class="container-fluid py-4">

    <!-- Header -->
    <div class="row mb-4">
      <div class="col">
        <h1 class="h3 mb-2">
          <i class="fas fa-clipboard-list me-2" aria-hidden="true"></i>
          Administration
        </h1>
        <p class="text-muted">Bienvenue <%= current_user.full_name %></p>
      </div>
      <div class="col-auto">
        <%= link_to root_path, class: 'btn btn-outline-secondary' do %>
          <i class="fas fa-home me-2" aria-hidden="true"></i>
          Retour au site
        <% end %>
        <%= link_to destroy_user_session_path, method: :delete, class: 'btn btn-outline-danger ms-2' do %>
          <i class="fas fa-sign-out-alt me-2" aria-hidden="true"></i>
          D√©connexion
        <% end %>
      </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h2 class="display-4 mb-0 text-primary"><%= @total_responses %></h2>
            <p class="text-muted mb-0">R√©ponses totales</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h2 class="display-4 mb-0 text-success"><%= @electoral_registered %></h2>
            <p class="text-muted mb-0">Inscrits liste √©lectorale</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <h2 class="display-4 mb-0 text-info"><%= @volunteers_count %></h2>
            <p class="text-muted mb-0">Int√©ress√©s newsletter</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation onglets -->
    <ul class="nav nav-tabs mb-4" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="responses-tab" data-bs-toggle="tab" data-bs-target="#responses" type="button" role="tab">
          <i class="fas fa-inbox me-2" aria-hidden="true"></i>
          R√©ponses (<%= @total_responses %>)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="articles-tab" data-bs-toggle="tab" data-bs-target="#articles" type="button" role="tab">
          <i class="fas fa-newspaper me-2" aria-hidden="true"></i>
          Articles
        </button>
      </li>
    </ul>

    <!-- Contenu onglets -->
    <div class="tab-content">

      <!-- ONGLET R√âPONSES -->
      <div class="tab-pane fade show active" id="responses" role="tabpanel">

        <!-- Actions -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong><i class="fas fa-filter me-2" aria-hidden="true"></i>Actions</strong>
              </div>
              <div>
                <%= link_to export_admin_survey_responses_path(format: :csv), class: 'btn btn-success' do %>
                  <i class="fas fa-file-csv me-2" aria-hidden="true"></i>
                  Exporter en CSV
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Tableau r√©ponses -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width: 50px;">#</th>
                    <th>Date</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Pays</th>
                    <th>Ville</th>
                    <th>Code postal</th>
                    <th>√Çge</th>
                    <th>Ann√©es en Belgique</th>
                    <th>Inscrit liste √©lectorale</th>
                    <th>Admin FR</th>
                    <th>Admin locale</th>
                    <th>Difficult√©s</th>
                    <th>Int√©r√™ts</th>
                    <th>Commentaires</th>
                    <th style="width: 100px;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if @all_responses.any? %>
                    <% @all_responses.each_with_index do |response, index| %>
                      <tr>
                        <td class="text-muted"><%= @all_responses.total_count - (@all_responses.current_page - 1) * @all_responses.limit_value - index %></td>
                        <td class="text-nowrap small">
                          <%= l(response.created_at, format: :short) %>
                        </td>
                        <td class="text-nowrap">
                          <strong><%= response.first_name %> <%= response.last_name %></strong>
                          <% if response.gender.present? %>
                            <br><small class="text-muted"><%= response.gender %></small>
                          <% end %>
                        </td>
                        <td class="small"><%= response.email %></td>
                        <td>
                          <% case response.country %>
                          <% when 'Belgique' %>
                            <span class="badge bg-dark">üáßüá™ BE</span>
                          <% when 'Pays-Bas' %>
                            <span class="badge bg-warning text-dark">üá≥üá± NL</span>
                          <% when 'Luxembourg' %>
                            <span class="badge bg-info">üá±üá∫ LU</span>
                          <% end %>
                        </td>
                        <td><%= response.city %></td>
                        <td><%= response.postal_code %></td>
                        <td><span class="badge bg-secondary"><%= response.age_range %></span></td>
                        <td class="small"><%= response.years_in_belgium %></td>
                        <td>
                          <% if response.electoral_registration == 'Oui' %>
                            <span class="badge bg-success">‚úì Oui</span>
                          <% elsif response.electoral_registration == 'Non' %>
                            <span class="badge bg-danger">‚úó Non</span>
                          <% else %>
                            <span class="badge bg-warning text-dark"><%= response.electoral_registration %></span>
                          <% end %>
                        </td>
                        <td>
                          <small class="text-nowrap"><%= response.french_admin_rating %></small>
                        </td>
                        <td>
                          <small class="text-nowrap"><%= response.belgian_admin_rating %></small>
                        </td>
                        <td>
                          <% if response.administrative_difficulties.present? %>
                            <% difficulties = JSON.parse(response.administrative_difficulties) rescue [] %>
                            <% if difficulties.any? %>
                              <small><%= difficulties.join(', ') %></small>
                            <% else %>
                              <span class="text-muted">-</span>
                            <% end %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td>
                          <% if response.interests.present? %>
                            <% interests = JSON.parse(response.interests) rescue [] %>
                            <% if interests.any? %>
                              <small><%= interests.join(', ') %></small>
                            <% else %>
                              <span class="text-muted">-</span>
                            <% end %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td>
                          <% if response.comments.present? %>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#commentModal<%= response.id %>">
                              <i class="fas fa-comment" aria-hidden="true"></i>
                            </button>

                            <!-- Modal commentaire -->
                            <div class="modal fade" id="commentModal<%= response.id %>" tabindex="-1">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Commentaire</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <div class="modal-body">
                                    <p><strong><%= response.first_name %> <%= response.last_name %></strong></p>
                                    <p><%= simple_format(response.comments) %></p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td>
                          <%= link_to '#', class: 'btn btn-sm btn-outline-primary me-1',
                                      title: 'D√©tails',
                                      data: {
                                        bs_toggle: 'modal',
                                        bs_target: "#detailModal#{response.id}"
                                      } do %>
                            <i class="fas fa-eye" aria-hidden="true"></i>
                          <% end %>

                          <%= button_to admin_survey_response_path(response),
                                        method: :delete,
                                        class: 'btn btn-sm btn-outline-danger',
                                        title: 'Supprimer',
                                        data: {
                                          turbo_method: :delete,
                                          turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer cette r√©ponse ?\n\n#{response.first_name} #{response.last_name}\n#{response.email}"
                                        },
                                        form: { style: 'display: inline-block;' } do %>
                            <i class="fas fa-trash" aria-hidden="true"></i>
                          <% end %>

                          <!-- Modal d√©tails complet -->
                          <div class="modal fade" id="detailModal<%= response.id %>" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title">R√©ponse compl√®te</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                  <dl class="row">
                                    <dt class="col-sm-4">Date</dt>
                                    <dd class="col-sm-8"><%= l(response.created_at, format: :long) %></dd>

                                    <dt class="col-sm-4">Nom complet</dt>
                                    <dd class="col-sm-8"><%= response.first_name %> <%= response.last_name %></dd>

                                    <dt class="col-sm-4">Email</dt>
                                    <dd class="col-sm-8"><%= response.email %></dd>

                                    <dt class="col-sm-4">Genre</dt>
                                    <dd class="col-sm-8"><%= response.gender.present? ? response.gender : '-' %></dd>

                                    <dt class="col-sm-4">Pays</dt>
                                    <dd class="col-sm-8"><%= response.country %></dd>

                                    <dt class="col-sm-4">Ville</dt>
                                    <dd class="col-sm-8"><%= response.city %></dd>

                                    <dt class="col-sm-4">Code postal</dt>
                                    <dd class="col-sm-8"><%= response.postal_code %></dd>

                                    <dt class="col-sm-4">Tranche d'√¢ge</dt>
                                    <dd class="col-sm-8"><%= response.age_range %></dd>

                                    <dt class="col-sm-4">Ann√©es en Belgique</dt>
                                    <dd class="col-sm-8"><%= response.years_in_belgium %></dd>

                                    <dt class="col-sm-4">Statut professionnel</dt>
                                    <dd class="col-sm-8"><%= response.professional_status.present? ? response.professional_status : '-' %></dd>

                                    <dt class="col-sm-4">Type d'employeur</dt>
                                    <dd class="col-sm-8"><%= response.employer_type.present? ? response.employer_type : '-' %></dd>

                                    <dt class="col-sm-4">Scolarit√© enfants</dt>
                                    <dd class="col-sm-8"><%= response.children_schooling.present? ? response.children_schooling : '-' %></dd>

                                    <dt class="col-sm-4">Admin fran√ßaise</dt>
                                    <dd class="col-sm-8"><%= response.french_admin_rating %></dd>

                                    <dt class="col-sm-4">Admin locale</dt>
                                    <dd class="col-sm-8"><%= response.belgian_admin_rating %></dd>

                                    <dt class="col-sm-4">Difficult√©s admin</dt>
                                    <dd class="col-sm-8">
                                      <% difficulties = JSON.parse(response.administrative_difficulties) rescue [] %>
                                      <%= difficulties.any? ? difficulties.join(', ') : '-' %>
                                    </dd>

                                    <dt class="col-sm-4">Inscrit liste √©lectorale</dt>
                                    <dd class="col-sm-8"><%= response.electoral_registration %></dd>

                                    <dt class="col-sm-4">A contact√© un √©lu</dt>
                                    <dd class="col-sm-8"><%= response.contacted_elected ? 'Oui' : 'Non' %></dd>

                                    <dt class="col-sm-4">Int√©r√™ts</dt>
                                    <dd class="col-sm-8">
                                      <% interests = JSON.parse(response.interests) rescue [] %>
                                      <%= interests.any? ? interests.join(', ') : '-' %>
                                    </dd>

                                    <dt class="col-sm-4">Commentaires</dt>
                                    <dd class="col-sm-8"><%= response.comments.present? ? simple_format(response.comments) : '-' %></dd>
                                  </dl>
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="16" class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3 d-block" aria-hidden="true"></i>
                        Aucune r√©ponse pour le moment
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Pagination -->
          <% if @all_responses.any? %>
            <div class="card-footer bg-white">
              <%= paginate @all_responses %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- ONGLET ARTICLES -->
      <div class="tab-pane fade" id="articles" role="tabpanel">

        <!-- Bouton nouvel article -->
        <div class="mb-4">
          <%= link_to new_admin_article_path, class: 'btn btn-primary btn-lg' do %>
            <i class="fas fa-plus me-2" aria-hidden="true"></i>
            Nouvel article
          <% end %>
        </div>

        <!-- Liste articles -->
        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-success text-white">
                <h3 class="h5 mb-0">
                  <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                  Articles publi√©s (<%= @published_articles.count %>)
                </h3>
              </div>
              <div class="card-body">
                <% if @published_articles.any? %>
                  <div class="list-group list-group-flush">
                    <% @published_articles.each do |article| %>
                      <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h4 class="h6 mb-1"><%= article.title %></h4>
                          <small class="text-muted">
                            <i class="fas fa-calendar me-1" aria-hidden="true"></i>
                            <%= l(article.published_at, format: :short) %>
                          </small>
                        </div>
                        <div>
                          <%= link_to article_path(article), class: 'btn btn-sm btn-outline-primary me-2', target: '_blank' do %>
                            <i class="fas fa-eye" aria-hidden="true"></i>
                          <% end %>
                          <%= link_to edit_admin_article_path(article.id), class: 'btn btn-sm btn-outline-secondary' do %>
                            <i class="fas fa-edit" aria-hidden="true"></i>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <p class="text-muted text-center py-4">Aucun article publi√©</p>
                <% end %>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-warning">
                <h3 class="h5 mb-0">
                  <i class="fas fa-edit me-2" aria-hidden="true"></i>
                  Brouillons (<%= @draft_articles.count %>)
                </h3>
              </div>
              <div class="card-body">
                <% if @draft_articles.any? %>
                  <div class="list-group list-group-flush">
                    <% @draft_articles.each do |article| %>
                      <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h4 class="h6 mb-1"><%= article.title %></h4>
                          <small class="text-muted">
                            <i class="fas fa-clock me-1" aria-hidden="true"></i>
                            Modifi√© <%= l(article.updated_at, format: :short) %>
                          </small>
                        </div>
                        <div>
                          <%= link_to edit_admin_article_path(article.id), class: 'btn btn-sm btn-outline-secondary' do %>
                            <i class="fas fa-edit" aria-hidden="true"></i>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <p class="text-muted text-center py-4">Aucun brouillon</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Info articles -->
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
          <strong>Les articles publi√©s apparaissent sur la page "Actualit√©s" du site.</strong>
          <br>
          <small>Vous pouvez cr√©er des brouillons et les publier plus tard.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .admin-simple .table {
    font-size: 0.9rem;
  }

  .admin-simple .table th {
    background: #f8f9fa;
    font-weight: 600;
    white-space: nowrap;
  }

  .admin-simple .table td {
    vertical-align: middle;
  }

  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
  }
</style>
